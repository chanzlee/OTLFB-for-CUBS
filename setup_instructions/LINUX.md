# Setup for Running O-TLFB Locally on Linux (Debian/Ubuntu)

## Django Setup

First, make sure your libraries are up to date by running `sudo apt update`.

### Python3

Install python3 using `sudo apt install python3`. You can confirm that it worked by opening a new terminal window and typing `which python3` - you should get something like `/usr/bin/python3`.

### Virtual Environments
Next, install `virtualenv` and `virtualenvwrapper`. Use the command `pip install virtualenv virtualenvwrapper` to install both of them in your Python3 packages folder. They will automatically be added to your PATH. You'll want to add the following lines to the end of your `.bashrc` file:

```bash
export WORKON_HOME=$HOME/.virtualenvs
source /usr/local/bin/virtualenvwrapper.sh
```

Now when you open a new terminal window, you should be able to use the command `lsvirtualenv` without any errors.

### Database (PostgreSQL)

Next, install PostgreSQL. Run `sudo apt install postgresql postgresql-contrib`. Once it finishes, run `sudo service postgresql start` to start the database service. You may need to run this command every time your computer restarts.

Once all this is done, you'll want to type the command `createdb tlfb` to instruct postgres to make a new database called "tlfb". When this runs successfully, you're ready to dive into the project itself.

```bash
sudo apt install postgresql postgresql-contrib
sudo service postgresql start
createdb tlfb
```

### Virtual Environment and Django

Clone the repository to a folder (mine is just ~/Desktop/TLFB). `cd` into the folder, then run `mkvirtualenv TLFB` to tell Python3 to make a virtual environment specifically for this project called TLFB. Once that's done, you should do a `which python` command, which should give you output similar to `/home/yourusername/.virtualenvs/TLFB/bin/python`. This indicates you're correctly in the virtual environment for this project. While still in the TLFB folder, type `pip install -r requirements.txt` to install into your local environment all the dependencies that this project has. This should run without any problems but might take a minute or two.

Once the dependencies are all installed, type `./manage.py migrate` to run the database migrations - these are a series of mutating SQL scripts automatically generated by Django based on our models that prime the database with the correct tables and columns for our project. Next, type `./manage.py createsuperuser` to create an administrator user that can log into the admin panel to modify data from there as well.


## Celery setup

### Info
We use celery to send data to a separate storage location like REDCap. To collect data you do not need to have this running. By default, all the data will be stored to the database without celery running. The reason we use celery is to remove any possibility of losing data if an API endpoint fails to upload or times out. Services like heroku only have so much processing power, and celery will add a task to a queue.

If you are going to be hosting this on heroku, you will need to have two hobby dynos for everything to run properly.

### Redis
Celery requires a solution to send and receive messages; usually this comes in the form of a separate service for this project we are using redis. To install redis, run `sudo apt install redis-server`.

Then open the redis config file with `sudo nano /etc/redis/redis.conf`. Find the line in this file that reads `supervised no` and change it to `supervised systemd`.

Then start redis using `sudo systemctl restart redis.service`. You may need to run this command every time your computer restarts.

If you don't want redis running in the background, you can run the following command whenever you start the O-TLFB server:

```bash
redis-server /etc/redis/redis.conf
```

Test to make sure it is running with `redis-cli ping`, and you should receive a 'PONG' response.
